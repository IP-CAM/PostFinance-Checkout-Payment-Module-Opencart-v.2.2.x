<?xml version="1.0" encoding="utf-8"?>
<modification>
	<code>PostFinanceCheckoutJournalCompatibility</code>
	<name>postfinancecheckout compatibility: patch for Journal Theme.
	</name>
	<version>1.0.1</version>
	<author>Customweb GmbH</author>
	<link>http://github.com/postfinancecheckout-payment/opencart</link>
	<file path="catalog/controller/{journal2,journal3}/checkout.php">
		<operation>
			<search><![CDATA[
		if (isset($this->session->data['error'])) {
            ]]></search>
			<add position="before"><![CDATA[
		require_once modification(DIR_SYSTEM . 'library/postfinancecheckout/helper.php');
		if (isset($this->request->get['order_id']) && \PostFinanceCheckoutHelper::instance($this->registry)->isValidOrder($this->request->get['order_id'])
			&& \PostFinanceCheckout\Service\Transaction::instance($this->registry)->waitForStates($this->request->get['order_id'], array(\PostFinanceCheckout\Sdk\Model\TransactionState::FAILED), 5)) {
			$transaction_info = \PostFinanceCheckout\Entity\TransactionInfo::loadByOrderId($this->registry, $this->request->get['order_id']);
			unset($this->registry->get('session')->data['order_id']);
			$this->data['error_warning'] = $transaction_info->getFailureReason();
		} else 
            ]]></add>
		</operation>
	</file>
</modification>
